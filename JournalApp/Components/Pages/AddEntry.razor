@page "/add-entry"
@layout MainLayout

@using JournalApp.Models
@using JournalApp.Services.EntryService
@using Microsoft.EntityFrameworkCore

@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IEntryService EntryService
@inject AppDbContext Db

<div class="page-header">
    <h1>New Journal Entry</h1>
    <p>Write your thoughts and feelings for today</p>
</div>

<div class="content-card mb-4">

    <!-- Title -->
    <div class="mb-4">
        <label class="form-label">Title</label>
        <input type="text"
               class="form-control"
               placeholder="Enter title"
               @bind="title" />
    </div>

    <!-- Content -->
    <div class="mb-5">
        <label class="form-label">Your Thoughts</label>
        <div id="quillEditor" style="height:200px;background:white;"></div>
    </div>

    <!-- Primary Mood -->
    <div class="mb-4">
        <p class="section-title">Primary Mood</p>
        <div class="d-flex flex-wrap gap-2">
            @foreach (var mood in moods)
            {
                <button type="button"
                        class="btn @(primaryMoodId == mood.MoodId ? "btn-primary" : "btn-outline-secondary")"
                        @onclick="() => primaryMoodId = mood.MoodId">
                    @mood.MoodName
                </button>
            }
        </div>
    </div>

    <!-- Secondary Mood -->
    <div class="mb-4">
        <p class="section-subtitle">Secondary Mood (optional)</p>
        <div class="d-flex flex-wrap gap-2">
            @foreach (var mood in moods)
            {
                <button type="button"
                        class="btn @(secondaryMoodId == mood.MoodId ? "btn-secondary" : "btn-outline-secondary")"
                        @onclick="() =>
                        secondaryMoodId =
                            secondaryMoodId == mood.MoodId ? 0 : mood.MoodId">
                @mood.MoodName
            </button>
                        }
        </div>
    </div>

    <!-- Category -->
    <div class="mb-4">
        <label class="form-label">Category</label>
        <select class="form-select" @bind="selectedTagId">
            <option value="0">Choose...</option>
            @foreach (var tag in tags)
            {
                <option value="@tag.TagId">@tag.TagName</option>
            }
            <option value="-1">➕ Enter your own tag</option>
        </select>
    </div>

    @if (selectedTagId == -1)
    {
        <div class="mb-4">
            <label class="form-label">Custom Tag</label>
            <input class="form-control"
                   placeholder="Enter your own tag"
                   @bind="customTagName" />
        </div>
    }

    <!-- Save Button -->
    <div class="d-grid mt-4">
        <button class="btn create-btn" @onclick="SaveEntry">
            Create Entry
        </button>
    </div>

</div>

@code {

    string title = "";
    int primaryMoodId = 0;
    int secondaryMoodId = 0;

    int selectedTagId = 0;
    string customTagName = "";

    List<Mood> moods = new();
    List<Tag> tags = new();

    int userId = 1; // TEMP

    protected override async Task OnInitializedAsync()
    {
        moods = await EntryService.GetMoods();
        tags = await EntryService.GetTags();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initQuill");
        }
    }

    async Task SaveEntry()
    {
        // ❗ one entry per day rule
        var existingEntryId =
            await EntryService.GetEntryIdByDate(DateTime.UtcNow.Date);

        if (existingEntryId != null)
        {
            await ShowAlert(
                "Already Exists",
                "You have already written a journal entry for today."
            );
            return;
        }

        if (string.IsNullOrWhiteSpace(title))
        {
            await ShowAlert("Alert", "Title is required");
            return;
        }

        if (primaryMoodId == 0)
        {
            await ShowAlert("Alert", "Please select a primary mood");
            return;
        }

        if (selectedTagId == 0)
        {
            await ShowAlert("Alert", "Please select a category");
            return;
        }

        if (selectedTagId == -1 && string.IsNullOrWhiteSpace(customTagName))
        {
            await ShowAlert("Alert", "Please enter custom tag");
            return;
        }

        var content = await JS.InvokeAsync<string>("getQuillHtml");

        // tag handling
        int finalTagId;

        if (selectedTagId == -1)
        {
            var existingTag = await Db.Tags.FirstOrDefaultAsync(t =>
                t.TagName.ToLower() == customTagName.Trim().ToLower());

            if (existingTag == null)
            {
                var newTag = new Tag
                {
                    TagName = customTagName.Trim(),
                    TagType = TagTypeEnum.Custom
                };

                Db.Tags.Add(newTag);
                await Db.SaveChangesAsync();

                finalTagId = newTag.TagId;
            }
            else
            {
                finalTagId = existingTag.TagId;
            }
        }
        else
        {
            finalTagId = selectedTagId;
        }

        var entry = new JournalEntry
        {
            Title = title,
            Content = content,
            TagId = finalTagId
            // EntryDate auto set
        };

        await EntryService.AddEntry(
            entry,
            userId,
            primaryMoodId,
            secondaryMoodId == 0 ? null : secondaryMoodId
        );

        await ShowAlert("Success", "Journal entry created successfully");
        Nav.NavigateTo("/all-entries");
    }

    async Task ShowAlert(string title, string message)
    {
        var page = Application.Current!.Windows[0].Page;
        if (page != null)
        {
            await page.DisplayAlertAsync(title, message, "OK");
        }
    }
}
