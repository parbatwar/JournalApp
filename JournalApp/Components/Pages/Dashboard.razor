@page "/dashboard"
@layout MainLayout
@using JournalApp.Models
@using JournalApp.Services.EntryService
@inject IEntryService EntryService
@inject IJSRuntime JS

<div class="db-head">
    <h1>Dashboard</h1>
    <p>Dashboard Analytics & Insights</p>
</div>

<!-- KPI CARDS -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card kpi-card">
            <div class="kpi-title">🔥 Daily Streak</div>
            <div class="kpi-value">@DailyStreak days</div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card kpi-card">
            <div class="kpi-title">🏆 Longest Streak</div>
            <div class="kpi-value">@LongestStreak days</div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card kpi-card">
            <div class="kpi-title">❌ Missed Days</div>
            <div class="kpi-value">@MissedDays</div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card kpi-card">
            <div class="kpi-title">😊 Frequent Mood</div>
            <div class="kpi-value">@MostFrequentMood</div>
        </div>
    </div>
</div>

<!-- ROW 1 -->
<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="card chart-card p-3">
            <div class="chart-title">Mood Distribution</div>
            <div class="chart-body">
                <canvas id="moodChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card chart-card p-3">
            <div class="chart-title">Most Used Tags</div>
            <div class="chart-body">
                <canvas id="mostUsedTagsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- ROW 2 -->
<div class="row g-4 mb-4">

    <div class="col-md-6">
        <div class="card chart-card p-3">
            <div class="chart-title">Word Count Trend</div>
            <div class="chart-body">
                <canvas id="wordTrendChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card chart-card p-3">
            <div class="chart-title">Tag Breakdown</div>
            <div class="chart-body">
                <canvas id="tagBreakdownChart"></canvas>
            </div>
        </div>
    </div>

</div>

@code {


    // DATA FROM SERVICE
    List<JournalEntry> entries = new();

    // KPI VALUES
    int DailyStreak = 0;
    int LongestStreak = 0;
    int MissedDays = 0;
    string MostFrequentMood = "-";

    protected override async Task OnInitializedAsync()
    {
        entries = await EntryService.GetEntries();

        CalculateKpis();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Charts should render only once and only if data exists
        if (firstRender && entries.Any())
        {
            await RenderCharts();
        }
    }

 
    // KPI CALCULATIONS
    void CalculateKpis()
    {
        if (!entries.Any())
            return;

        // Get unique entry dates (sorted)
        var entryDates = entries
            .Select(e => e.EntryDate.Date)
            .Distinct()
            .OrderBy(d => d)
            .ToList();

        // ---------- DAILY STREAK ----------
        DailyStreak = 0;
        var today = DateTime.Today;
        var checkDate = entryDates.Contains(today) ? today : today.AddDays(-1);

        while (entryDates.Contains(checkDate))
        {
            DailyStreak++;
            checkDate = checkDate.AddDays(-1);
        }

        // ---------- LONGEST STREAK ----------
        int tempStreak = 0;
        DateTime? lastDate = null;

        foreach (var date in entryDates)
        {
            if (lastDate == null || (date - lastDate.Value).Days == 1)
                tempStreak++;
            else
                tempStreak = 1;

            LongestStreak = Math.Max(LongestStreak, tempStreak);
            lastDate = date;
        }

        // ---------- MISSED DAYS ----------
        int totalDays = (entryDates.Max() - entryDates.Min()).Days + 1;
        MissedDays = totalDays - entryDates.Count;

        // ---------- MOST FREQUENT MOOD ----------
        MostFrequentMood = entries
            .SelectMany(e => e.EntryMoods)
            .GroupBy(m => m.Mood!.MoodName)
            .OrderByDescending(g => g.Count())
            .Select(g => g.Key)
            .FirstOrDefault() ?? "-";
    }


    // CHART DATA + JS CALLS
    async Task RenderCharts()
    {
        // ----- MOOD DISTRIBUTION -----
        var moodData = entries
            .SelectMany(e => e.EntryMoods)
            .GroupBy(m => m.Mood!.MoodCategory)
            .Select(g => new
            {
                Label = g.Key.ToString(),          // Positive / Neutral / Negative
                Count = g.Count()
            })
            .ToList();


        if (moodData.Any())
        {
            await JS.InvokeVoidAsync(
                "renderMoodChart",
                moodData.Select(x => x.Label).ToArray(),
                moodData.Select(x => x.Count).ToArray()
            );
        }

        // ----- WORD COUNT TREND -----
        var wordTrend = entries
            .GroupBy(e => e.EntryDate.Date)
            .OrderBy(g => g.Key)
            .Select(g => new
            {
                Date = g.Key.ToString("MMM dd"),
                Count = g.Sum(e =>
                    e.Content.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length)
            })
            .ToList();

        if (wordTrend.Any())
        {
            await JS.InvokeVoidAsync(
                "renderWordTrendChart",
                wordTrend.Select(x => x.Date).ToArray(),
                wordTrend.Select(x => x.Count).ToArray()
            );
        }

        // ----- TAG DATA -----
        var tagData = entries
            .Where(e => e.Tag != null)
            .GroupBy(e => e.Tag!.TagName)
            .Select(g => new { Name = g.Key, Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .Take(5)
            .ToList();

        if (tagData.Any())
        {
            await JS.InvokeVoidAsync(
                "renderMostUsedTagsChart",
                tagData.Select(x => x.Name).ToArray(),
                tagData.Select(x => x.Count).ToArray()
            );

            await JS.InvokeVoidAsync(
                "renderTagBreakdownChart",
                tagData.Select(x => x.Name).ToArray(),
                tagData.Select(x => x.Count).ToArray()
            );
        }
    }
}
