@page "/"
@layout MainLayout
@using JournalApp.Models
@using Microsoft.EntityFrameworkCore
@using JournalApp.Services
@inject AppDbContext Db
@inject Session Session
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject IEntryService EntryService


<div class="page-header">
    <h1>New Journal Entry</h1>
    <p>Write your thoughts and feelings for today</p>
</div>

<div class="content-card">

    <!-- Title -->
    <div class="mb-4">
        <label for="entryTitle" class="form-label">Title</label>
        <input 
            type="text" 
            class="form-control" 
            id="entryTitle" 
            placeholder="Enter a suitable title"
            @bind = "title">
    </div>

    <div class="mb-5">
        <label class="form-label">Your Thoughts</label>
        <div id="quillEditor" style="height:200px;background:white;"></div>
    </div>

    <!-- Primary Mood -->
    <div class="mb-4">
        <p class="section-title">Primary Mood</p>
        <div class="d-flex flex-wrap gap-2">
            @foreach (var mood in moods)
            {
                <button type="button"
                        class="btn @(primaryMoodId == mood.MoodId ? "btn-dark" : "btn-outline-dark")"
                        @onclick="() => primaryMoodId = mood.MoodId">
                    @mood.MoodName
                </button>
            }
        </div>
    </div>

    <!-- Secondary Mood -->
    <div class="mb-5">
        <p class="section-subtitle">Secondary mood (optional)</p>
        <div class="d-flex flex-wrap gap-2">
            @foreach (var mood in moods)
            {
                <button type="button"
                        class="btn @(secondaryMoodId == mood.MoodId ? "btn-secondary" : "btn-outline-secondary")"
                        @onclick="() => secondaryMoodId = mood.MoodId">
                    @mood.MoodName
                </button>
            }
        </div>
    </div>


    <!-- Tags -->
    <div class="mb-4">
        <p class="section-title">Tags</p>

        <div class="row">
            <div class="col">
                <label class="form-label">Select from presets</label>
                <select class="form-select" @bind="selectedTagId">
                    <option value="0">Choose...</option>
                    @foreach (var tag in tags)
                    {
                        <option value="@tag.TagId">@tag.TagName</option>
                    }
                </select>
            </div>

            @* <div class="col">
                <label class="form-label">Or create custom tag</label>
                <input class="form-control"
                       placeholder="Type tag name"
                       @bind="customTagName" />
            </div> *@
        </div>
    </div>

    <!-- Action Button -->
    <div class="d-grid mt-4 mb-5">
        <button type="button" class="btn create-btn" @onclick="SaveEntry">
            Create Entry 🚀
        </button>

    </div>
</div>


@code {
    // form fields
    string title = "";
    int primaryMoodId = 0;
    int secondaryMoodId = 0;
    int selectedTagId = 0;

    // loaded from DB once
    List<Mood> moods = new();
    List<Tag> tags = new();

    protected override async Task OnInitializedAsync()
    {
        // login guard (fast)
        if (Session.CurrentUser == null)
        {
            Nav.NavigateTo("/login");
            return;
        }

        // load once
        moods = await Db.Moods.AsNoTracking().ToListAsync();
        tags = await Db.Tags.AsNoTracking()
            .Where(t => t.TagType == TagTypeEnum.Predefined)
            .ToListAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initQuill");
        }
    }

    async Task SaveEntry()
    {
        // basic validation
        if (string.IsNullOrWhiteSpace(title))
        {
            await JS.InvokeVoidAsync("alert", "Title required ❗");
            return;
        }

        if (primaryMoodId == 0)
        {
            await JS.InvokeVoidAsync("alert", "Select primary mood ❗");
            return;
        }

        if (selectedTagId == 0)
        {
            await JS.InvokeVoidAsync("alert", "Select a tag ❗");
            return;
        }

        // get editor content
        var content = await JS.InvokeAsync<string>("getQuillHtml");

        // save journal entry
        var entry = new JournalEntry
        {
            Title = title,
            Content = content,
            UserId = Session.CurrentUser!.UserId,
            TagId = selectedTagId,
            EntryDate = DateTime.Today,
            CreatedAt = DateTime.Now,
            UpdatedAt = DateTime.Now
        };

        await EntryService.AddEntry(
        entry,
        primaryMoodId,
        secondaryMoodId == 0 ? null : secondaryMoodId
    );

        await JS.InvokeVoidAsync("alert", "Entry saved ✅");
        Nav.NavigateTo("/");
    }
}