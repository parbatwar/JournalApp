@page "/login"
@layout EmptyLayout
@using JournalApp.FormModels
@using JournalApp.Services
@inject IUserService UserService
@inject Session Session
@inject NavigationManager Nav

<EditForm Model="login" OnValidSubmit="DoLogin">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="login-bg">
        <div class="login-card">

            @if (!string.IsNullOrEmpty(error))
            {
                <p class="text-danger text-center mb-3">@error</p>
            }

            <div class="avatar">
                <div class="avatar-icon">👤</div>
            </div>

            <div class="field">
                <InputText class="form-control"
                           type="email"
                           placeholder="Email"
                           @bind-Value="login.Email" />
            </div>

            <div class="field">
                <InputText class="form-control"
                           type="password"
                           placeholder="Password"
                           @bind-Value="login.Password" />
            </div>

            <button class="login-btn mb-3" type="submit">LOGIN</button>

            <NavLink href="/register" class="mt-3 text-center text-white text-decoration-none">
                Create new account
            </NavLink>
        </div>
    </div>
</EditForm>

@code {
    LoginModel login = new();
    string error = "";

    protected override void OnInitialized()
    {
        Session.CurrentUser = null;   // force logout when opening login page
    }

    async Task DoLogin()
    {
        var user = await UserService.LoginAsync(login.Email, login.Password);

        if (user == null)
        {
            error = "Wrong email or password";
            return;
        }

        Session.CurrentUser = user;
        Nav.NavigateTo("/");
    }
}
