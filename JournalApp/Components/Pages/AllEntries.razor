@page "/all-entries"
@layout MainLayout

@using JournalApp.Models
@using JournalApp.Services.EntryService

@inject NavigationManager Nav
@inject IEntryService EntryService

<div class="page-header">
    <h1>All Entries</h1>
    <p>View your journal history</p>
</div>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">

<!-- SEARCH + FILTER BAR -->
<div class="container mb-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="d-flex gap-2 align-items-center">

                <!-- Search -->
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>

                    <input class="form-control"
                           placeholder="Search title or content..."
                           value="@searchText"
                           @oninput="e =>
                           {
                               searchText = e.Value?.ToString() ?? string.Empty;
                               OnFilterChanged();
                           }" />
                </div>

                <!-- Mood filter -->
                <select class="form-select w-auto"
                        value="@selectedMood"
                        @onchange="e =>
                        {
                            selectedMood = e.Value?.ToString() ?? string.Empty;
                            OnFilterChanged();
                        }">
                    <option value="">All Moods</option>

                    @foreach (var mood in AllMoods)
                    {
                        <option value="@mood.MoodName">@mood.MoodName</option>
                    }
                </select>

                <!-- Tag filter -->
                <select class="form-select w-auto"
                        value="@selectedTag"
                        @onchange="e =>
                        {
                            selectedTag = e.Value?.ToString() ?? string.Empty;
                            OnFilterChanged();
                        }">
                    <option value="">All Categories</option>

                    @foreach (var tag in AllTags)
                    {
                        <option value="@tag.TagName">@tag.TagName</option>
                    }
                </select>

            </div>
        </div>
    </div>
</div>

<!-- TABLE -->
<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>S.No.</th>
                <th>Title</th>
                <th>Mood</th>
                <th>Category</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            @{
                int i = (CurrentPage - 1) * PageSize + 1;
            }

            @foreach (var entry in PagedEntries)
            {
                <tr style="cursor:pointer"
                    @onclick="() => OpenEntry(entry.JournalId)">

                    <td>@i</td>
                    <td>@entry.Title</td>

                    <td>
                        @string.Join(", ",
                            entry.EntryMoods
                                 .OrderBy(m => m.MoodRole)
                                 .Select(m => m.Mood!.MoodName)
                        )
                    </td>

                    <td>@entry.Tag?.TagName</td>
                    <td>@entry.EntryDate.ToString("yyyy-MM-dd")</td>
                </tr>

                i++;
            }
        </tbody>
    </table>

    <!-- PAGINATION -->
    <nav>
        <ul class="pagination justify-content-end">

            <li class="page-item @(CurrentPage == 1 ? "disabled" : "")">
                <a class="page-link" href="#"
                   @onclick="PrevPage"
                   @onclick:preventDefault>
                    Previous
                </a>
            </li>

            <li class="page-item active">
                <span class="page-link">@CurrentPage</span>
            </li>

            <li class="page-item @(CurrentPage == TotalPages ? "disabled" : "")">
                <a class="page-link" href="#"
                   @onclick="NextPage"
                   @onclick:preventDefault>
                    Next
                </a>
            </li>

        </ul>
    </nav>
</div>

@code {

    // =========================
    // DATA
    // =========================
    List<JournalEntry> Entries = new();
    List<JournalEntry> PagedEntries = new();

    List<Mood> AllMoods = new();
    List<Tag> AllTags = new();

    // =========================
    // SEARCH + FILTER
    // =========================
    string searchText = "";
    string selectedMood = "";
    string selectedTag = "";

    // =========================
    // PAGINATION
    // =========================
    int CurrentPage = 1;
    int PageSize = 5;
    int TotalPages = 1;

    protected override async Task OnInitializedAsync()
    {
        // single-user app → service le user internally handle garcha
        Entries = await EntryService.GetEntries();

        // distinct moods
        AllMoods = Entries
            .SelectMany(e => e.EntryMoods)
            .Select(em => em.Mood!)
            .DistinctBy(m => m.MoodId)
            .ToList();

        // distinct tags
        AllTags = Entries
            .Where(e => e.Tag != null)
            .Select(e => e.Tag!)
            .DistinctBy(t => t.TagId)
            .ToList();

        ApplyFilters();
    }

    IEnumerable<JournalEntry> FilteredEntries =>
        Entries.Where(e =>
            (string.IsNullOrWhiteSpace(searchText) ||
             e.Title.Contains(searchText, StringComparison.OrdinalIgnoreCase) ||
             e.Content.Contains(searchText, StringComparison.OrdinalIgnoreCase))
            &&
            (string.IsNullOrEmpty(selectedMood) ||
             e.EntryMoods.Any(m => m.Mood!.MoodName == selectedMood))
            &&
            (string.IsNullOrEmpty(selectedTag) ||
             e.Tag!.TagName == selectedTag)
        );

    void ApplyFilters()
    {
        var list = FilteredEntries.ToList();

        TotalPages = Math.Max(1,
            (int)Math.Ceiling((double)list.Count / PageSize));

        CurrentPage = Math.Min(CurrentPage, TotalPages);

        PagedEntries = list
            .Skip((CurrentPage - 1) * PageSize)
            .Take(PageSize)
            .ToList();
    }

    void OnFilterChanged()
    {
        CurrentPage = 1;
        ApplyFilters();
    }

    void NextPage()
    {
        if (CurrentPage < TotalPages)
        {
            CurrentPage++;
            ApplyFilters();
        }
    }

    void PrevPage()
    {
        if (CurrentPage > 1)
        {
            CurrentPage--;
            ApplyFilters();
        }
    }

    void OpenEntry(int entryId)
    {
        Nav.NavigateTo($"/entry/{entryId}");
    }
}
