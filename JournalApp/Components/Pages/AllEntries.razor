@page "/all-entries"
@layout MainLayout

@using JournalApp.Models
@using JournalApp.Services.EntryService
@inject IEntryService EntryService
@inject IJSRuntime JS

<h1>All Entries</h1>
<p>View your journal history</p>

<!-- FILTER BAR -->
<div class="mb-3 d-flex gap-2 flex-wrap">

    <input class="form-control w-25"
           placeholder="Search title..."
           @oninput="e => { searchText = e.Value?.ToString() ?? ""; Apply(); }" />

    <select class="form-select w-auto"
            @onchange="e => { selectedMood = e.Value?.ToString() ?? ""; Apply(); }">
        <option value="">All Moods</option>
        @foreach (var m in AllMoods)
        {
            <option value="@m.MoodName">@m.MoodName</option>
        }
    </select>

    <select class="form-select w-auto"
            @onchange="e => { selectedTag = e.Value?.ToString() ?? ""; Apply(); }">
        <option value="">All Categories</option>
        @foreach (var t in AllTags)
        {
            <option value="@t.TagName">@t.TagName</option>
        }
    </select>

    <input type="date" class="form-control w-auto" @bind="fromDate" />
    <input type="date" class="form-control w-auto" @bind="toDate" />

    <button class="btn btn-dark" @onclick="ExportPdf">Export PDF</button>
</div>

<!-- PAGED TABLE -->
<table class="table table-bordered">
    <thead>
        <tr>
            <th>#</th>
            <th>Title</th>
            <th>Mood</th>
            <th>Category</th>
            <th>Date</th>
        </tr>
    </thead>
    <tbody>
        @{
            int i = (page - 1) * pageSize + 1;
        }
        @foreach (var e in Paged)
        {
            <tr>
                <td>@i</td>
                <td>@e.Title</td>
                <td>@string.Join(", ", e.EntryMoods.Select(m => m.Mood!.MoodName))</td>
                <td>@e.Tag?.TagName</td>
                <td>@e.EntryDate.ToString("yyyy-MM-dd")</td>
            </tr>
            i++;
        }
    </tbody>
</table>

<!-- PAGINATION -->
<div class="d-flex justify-content-end gap-2">
    <button class="btn btn-outline-secondary"
            disabled="@(page==1)"
            @onclick="()=>Change(-1)">Prev</button>

    <span>@page</span>

    <button class="btn btn-outline-secondary"
            disabled="@(page==totalPages)"
            @onclick="()=>Change(1)">Next</button>
</div>

<!-- EXPORT TABLE (NO PAGINATION) -->
<div id="exportArea" style="display:none">
    <h3>Journal Entries</h3>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>#</th>
                <th>Title</th>
                <th>Mood</th>
                <th>Category</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody>
            @{
                int j = 1;
            }
            @foreach (var e in ExportList)
            {
                <tr>
                    <td>@j</td>
                    <td>@e.Title</td>
                    <td>@string.Join(", ", e.EntryMoods.Select(m => m.Mood!.MoodName))</td>
                    <td>@e.Tag?.TagName</td>
                    <td>@e.EntryDate.ToString("yyyy-MM-dd")</td>
                </tr>
                j++;
            }
        </tbody>
    </table>
</div>

@code {

    List<JournalEntry> Entries = new();
    List<JournalEntry> Paged = new();
    List<JournalEntry> ExportList = new();

    List<Mood> AllMoods = new();
    List<Tag> AllTags = new();

    string searchText = "";
    string selectedMood = "";
    string selectedTag = "";
    DateTime? fromDate;
    DateTime? toDate;

    int page = 1;
    int pageSize = 5;
    int totalPages = 1;

    protected override async Task OnInitializedAsync()
    {
        Entries = await EntryService.GetEntries();

        AllMoods = Entries.SelectMany(e => e.EntryMoods)
                          .Select(m => m.Mood!)
                          .DistinctBy(m => m.MoodId)
                          .ToList();

        AllTags = Entries.Where(e => e.Tag != null)
                         .Select(e => e.Tag!)
                         .DistinctBy(t => t.TagId)
                         .ToList();

        Apply();
    }

    void Apply()
    {
        var list = Entries.Where(e =>
            (string.IsNullOrEmpty(searchText) || e.Title.Contains(searchText, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrEmpty(selectedMood) || e.EntryMoods.Any(m => m.Mood!.MoodName == selectedMood)) &&
            (string.IsNullOrEmpty(selectedTag) || e.Tag!.TagName == selectedTag)
        ).ToList();

        totalPages = Math.Max(1, (int)Math.Ceiling(list.Count / (double)pageSize));
        page = Math.Min(page, totalPages);

        Paged = list.Skip((page - 1) * pageSize).Take(pageSize).ToList();
        ExportList = list;
    }

    void Change(int d)
    {
        page += d;
        Apply();
    }

    async Task ExportPdf()
    {
        ExportList = ExportList
            .Where(e =>
                (!fromDate.HasValue || e.EntryDate.Date >= fromDate.Value.Date) &&
                (!toDate.HasValue || e.EntryDate.Date <= toDate.Value.Date))
            .OrderBy(e => e.EntryDate)
            .ToList();

        await JS.InvokeVoidAsync("exportPdf");
    }
}
