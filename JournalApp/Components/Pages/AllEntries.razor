@page "/all-entries"
@layout MainLayout
@using JournalApp.Models
@using JournalApp.Services.EntryService
@inject NavigationManager Nav
@inject IEntryService EntryService
@inject IJSRuntime JS

<div class="page-header px-2">
    <h1>All Entries</h1>
    <p class="text-muted">Manage your thoughts and journal history</p>
</div>

<div class="filter-wrapper">
    <div class="filter-container">
        <div class="filter-item flex-grow-1">
            <i class="bi bi-search search-icon"></i>
            <input type="text" class="clean-input" placeholder="Search entries..."
                   @oninput='e => { searchText = e.Value?.ToString() ?? ""; OnFilterChanged(); }' />
        </div>

        <div class="v-divider"></div>

        <div class="filter-item">
            <select class="clean-select" @onchange='e => { selectedMood = e.Value?.ToString() ?? ""; OnFilterChanged(); }'>
                <option value="">Mood</option>
                @foreach (var mood in AllMoods)
                {
                    <option value="@mood.MoodName">@mood.MoodName</option>
                }
            </select>
        </div>

        <div class="v-divider"></div>

        <div class="filter-item">
            <select class="clean-select" @onchange='e => { selectedTag = e.Value?.ToString() ?? ""; OnFilterChanged(); }'>
                <option value="">Tag</option>
                @foreach (var tag in AllTags)
                {
                    <option value="@tag.TagName">@tag.TagName</option>
                }
            </select>
        </div>

        <div class="v-divider"></div>

        <div class="date-range-box">
            <input type="date" class="clean-date" @bind="startDate" @bind:after="OnFilterChanged" />
            <span class="date-arrow"><i class="bi bi-arrow-right-short"></i></span>
            <input type="date" class="clean-date" @bind="endDate" @bind:after="OnFilterChanged" />
        </div>

        <button class="pdf-btn" @onclick="ExportToPdf" title="Export to PDF">
            <i class="bi bi-file-earmark-pdf"></i>
        </button>
    </div>
</div>

<div class="card premium-card">
    <div class="table-responsive">
        <table class="table align-middle">
            <thead>
                <tr>
                    <th width="60">#</th>
                    <th>Title</th>
                    <th>Moods</th>
                    <th>Category</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                @{
                    int i = (CurrentPage - 1) * PageSize + 1;
                }
                @foreach (var entry in PagedEntries)
                {
                    <tr @onclick="() => OpenEntry(entry.JournalId)">
                        @* Simple 1, 2, 3 banauna @i matrai rakhne *@
                        <td class="text-body-secondary">@i</td>

                        @* text-dark hataera entry-title thapiyo *@
                        <td class="fw-bold entry-title">@entry.Title</td>

                        <td>
                            @foreach (var m in entry.EntryMoods)
                            {
                                <span class="mood-badge me-1">@m.Mood?.MoodName</span>
                            }
                        </td>

                        <td style="padding-left: 18px;">
                            <span class="text-body-secondary">@entry.Tag?.TagName</span>
                        </td>

                        <td class="text-body-secondary">@entry.EntryDate.ToString("MMM dd, yyyy")</td>
                    </tr>
                    i++;
                }
            </tbody>
        </table>
    </div>

    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item @(CurrentPage == 1 ? "disabled" : "")">
                <button class="page-link shadow-none" @onclick="PrevPage"><i class="bi bi-arrow-left"></i></button>
            </li>
            <li class="page-item"><span class="page-link border-0 fw-bold px-3">@CurrentPage</span></li>
            <li class="page-item @(CurrentPage == TotalPages ? "disabled" : "")">
                <button class="page-link shadow-none" @onclick="NextPage"><i class="bi bi-arrow-right"></i></button>
            </li>
        </ul>
    </nav>
</div>


@* For exporting table layout *@
<div id="full-export-table" style="display: none; padding: 30px;">
    <h2 style="text-align: center; margin-bottom: 20px;">Journal Entries List</h2>
    <table style="width: 100%; border-collapse: collapse; font-family: sans-serif;">
        <thead>
            <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="padding: 10px; text-align: left;">Date</th>
                <th style="padding: 10px; text-align: left;">Title</th>
                <th style="padding: 10px; text-align: left;">Moods</th>
                <th style="padding: 10px; text-align: left;">Category</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var entry in FilteredEntries) @* Yesle pagination bina ko sabai filtered data lincha *@
            {
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px;">@entry.EntryDate.ToString("MMM dd, yyyy")</td>
                    <td style="padding: 10px; font-weight: bold;">@entry.Title</td>
                    <td style="padding: 10px;">
                        @string.Join(", ", entry.EntryMoods.Select(m => m.Mood?.MoodName))
                    </td>
                    <td style="padding: 10px;">@entry.Tag?.TagName</td>
                </tr>
            }
        </tbody>
    </table>
</div>


@code {

    // DATA (Service bata aako)
    List<JournalEntry> Entries = new();        // DB bata aako full data
    List<JournalEntry> PagedEntries = new();  // screen ma dekhaune data
    List<Mood> AllMoods = new();              // filter dropdown ko lagi
    List<Tag> AllTags = new();   // tag dropdown ko lagi



    // FILTER STATE (UI bata aauxa)
    string searchText = "";
    string selectedMood = "";
    string selectedTag = "";
    DateTime? startDate;
    DateTime? endDate;


    // PAGINATION STATE
    int CurrentPage = 1;
    int PageSize = 5;
    int TotalPages = 1;

    protected override async Task OnInitializedAsync()
    {
        // UI → Service → Repository → DbContext
        Entries = await EntryService.GetEntries();

        // Mood dropdown ko data prepare
        AllMoods = Entries
            .SelectMany(e => e.EntryMoods)
            .Select(em => em.Mood!)
            .DistinctBy(m => m.MoodId)
            .ToList();

        AllTags = Entries
            .Where(e => e.Tag != null)
            .Select(e => e.Tag!)
            .DistinctBy(t => t.TagId)
            .ToList();


        ApplyFilters();
    }

  
    // FILTER LOGIC
    IEnumerable<JournalEntry> FilteredEntries =>
        Entries.Where(e =>
            (string.IsNullOrWhiteSpace(searchText) ||
                e.Title.Contains(searchText, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrEmpty(selectedMood) ||
                e.EntryMoods.Any(m => m.Mood!.MoodName == selectedMood)) &&
            (string.IsNullOrEmpty(selectedTag) ||
                e.Tag != null && e.Tag.TagName == selectedTag) &&

            (!startDate.HasValue || e.EntryDate.Date >= startDate.Value.Date) &&
            (!endDate.HasValue || e.EntryDate.Date <= endDate.Value.Date)
        );


    // APPLY FILTER + PAGINATION
    void ApplyFilters()
    {
        var list = FilteredEntries
            .OrderByDescending(e => e.EntryDate)
            .ToList();

        TotalPages = Math.Max(1,
            (int)Math.Ceiling(list.Count / (double)PageSize));

        if (CurrentPage > TotalPages)
            CurrentPage = TotalPages;

        PagedEntries = list
            .Skip((CurrentPage - 1) * PageSize)
            .Take(PageSize)
            .ToList();
    }


    // EVENTS (UI bata call huncha)
    void OnFilterChanged()
    {
        CurrentPage = 1;
        ApplyFilters();
    }

    void NextPage()
    {
        if (CurrentPage < TotalPages)
        {
            CurrentPage++;
            ApplyFilters();
        }
    }

    void PrevPage()
    {
        if (CurrentPage > 1)
        {
            CurrentPage--;
            ApplyFilters();
        }
    }

    void OpenEntry(int id)
    {
        Nav.NavigateTo($"/entry/{id}");
    }


    async Task ExportToPdf()
    {
        try
        {
            await JS.InvokeVoidAsync("generatePDF", "Journal_Export");

            await ShowAlert("Export Success", "Journal entries have been successfully exported to PDF.");
        }
        catch (Exception ex)
        {
            await ShowAlert("Error", "Failed to export PDF: " + ex.Message);
        }
    }

    async Task ShowAlert(string title, string message)
    {
        var page = Application.Current!.Windows[0].Page;
        if (page != null)
        {
            await page.DisplayAlertAsync(title, message, "OK");
        }
    }
}


